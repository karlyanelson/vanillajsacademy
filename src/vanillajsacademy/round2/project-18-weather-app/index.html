---
layout: layout_project.njk
round: "2"
number: "18"
title: "Weather App"
tags: [project, round2]
---

<main>
  <p class="project-metadata">Round {{round}} • Project {{number}}</p>
  <h1 tabindex="-1" class="project-title">{{title}}</h1>

  <div id="app">Checking the weather near you...</div>
</main>

<script>
  const app = document.querySelector("#app");

  const WEATHER_BIT_KEY = "";

  /*!
   * Sanitize and encode all HTML in a user-submitted string
   * (c) 2018 Chris Ferdinandi, MIT License, https://gomakethings.com
   * @param  {String} str  The user-submitted string
   * @return {String} str  The sanitized string
   */
  function sanitizeHTML(str) {
    var temp = document.createElement("div");
    temp.textContent = str;
    return temp.innerHTML;
  }

  const showWeather = ({
    temp,
    weather,
    city_name,
    state_code,
    country_code,
  }) => {
    app.innerHTML = `
      <h2>Current Weather </h2>
      <img class="img-small" src="https://www.weatherbit.io/static/img/icons/${
        weather.icon
      }.png" alt="${sanitizeHTML(weather.description)}." />
      <p>${sanitizeHTML(temp)}°F and ${sanitizeHTML(
      weather.description
    )} in ${sanitizeHTML(city_name)}, ${sanitizeHTML(
      state_code
    )} ${sanitizeHTML(country_code)}</p>
    `;
  };

  const getWeatherData = async (position) => {
    try {
      let response = await fetch(
        `/.netlify/functions/getweather?lon=${position.coords.longitude}&lat=${position.coords.latitude}`
      );

      // `http://api.weatherbit.io/v2.0/current?key=${WEATHER_BIT_KEY}&lat=${position.coords.latitude}&lon=${position.coords.longitude}&units=I`;

      if (!response.ok) {
        throw "Response failed. Status: " + response.status;
      }

      let data = await response.json();

      if (!data) throw "No data";

      console.log(data.data[0]);

      showWeather(data.data[0]);
    } catch (error) {
      console.warn(error);
    }
  };

  const showError = (error) => {
    console.warn(error);
    app.innerHTM =
      "Sorry something went wrong. Please refresh the page and try again.";
  };

  // Request access to the user's location
  navigator.geolocation.getCurrentPosition(getWeatherData, showError);
</script>
